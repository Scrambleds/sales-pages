name: "[Venio Sales Page] GitOps Pipeline ðŸš€"

on:
  workflow_dispatch:
    inputs:
      build-configuration:
        description: "Build Configuration"
        required: true
        default: "DEV"
        type: choice
        options:
          - DEV
          - UAT
          - PROD

      deploy-environment:
        description: "Target Environment for GitOps Deployment"
        required: true
        default: "DEV"
        type: choice
        options:
          - DEV
          - UAT
          - PROD

      auto-deploy:
        description: "ðŸš€ Auto Deploy (Skip PR Creation)"
        required: true
        type: boolean
        default: false
jobs:
  acr-build:
    uses: GofiveCorp/gofive-gitops/.github/workflows/acr-build.yaml@v4
    with:
      environment: "${{ github.event.inputs.build-configuration }}"
      image: 'venio/venio-sales-page'
      tag: "${{ github.event.inputs.build-configuration }}-${{ github.run_id }}"
      build_args: "BUILD_CONFIGURATION=${{ github.event.inputs.build-configuration }}"

    secrets:
      AZURE_ARM_CERTIFICATE: ${{ secrets.AZURE_ARM_CERTIFICATE }}
      AZURE_ARM_CLIENT_ID: ${{ secrets.AZURE_ARM_CLIENT_ID }}
      AZURE_ARM_CLIENT_SECRET: ${{ secrets.AZURE_ARM_CLIENT_SECRET }}

  update-gitops:
    needs: [acr-build]
    uses: GofiveCorp/gofive-gitops/.github/workflows/update-gitops.yaml@v4
    with:
      repository: 'venio'
      application: 'venio/venio-sales-page'
      application_label: 'Venio Sales Page'
      environment: ${{ github.event.inputs.deploy-environment }}
      tag: ${{ needs.acr-build.outputs.tag }}
      skip_pr: ${{ github.event.inputs.auto-deploy == 'true' }}

    secrets:
      GH_TOKEN: ${{ secrets.WORKFLOW_AGENT_PAT }}